<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Contr√¥le Avion</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body class="mobile-page">
    <div id="status">Chargement Socket.IO...</div>

    <!-- JOYSTICK BAS GAUCHE -->
    <div class="joystick-wrapper">
        <div id="joystick-base">
            <div id="joystick-knob"></div>
        </div>
    </div>

    <!-- BOUTONS ACTIONS BAS DROITE -->
    <div class="actions-right">
        <button id="accelerate">
            <span class="plane-icon">‚úàÔ∏è</span> Acc√©l√©rer
        </button>
        <button id="shoot-button">
            <span class="plane-icon">üí•</span> Tirer
        </button>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const statusDiv = document.getElementById('status');

        let socket;
        try {
            statusDiv.textContent = 'Connexion Socket.IO...';
            socket = io(); // m√™me host que la page
        } catch (error) {
            statusDiv.textContent = 'Erreur Socket.IO: ' + error.message;
            console.error('Socket.IO Error:', error);
        }

        const accelerateBtn = document.getElementById('accelerate');
        const shootButton = document.getElementById('shoot-button');
        const joystickBase = document.getElementById('joystick-base');
        const joystickKnob = document.getElementById('joystick-knob');

        socket.on('connect', () => {
            statusDiv.textContent = 'Avion Connect√© ‚úàÔ∏è';
            statusDiv.style.color = '#0f0';
        });

        socket.on('disconnect', () => {
            statusDiv.textContent = 'Avion D√©connect√© ‚úó';
            statusDiv.style.color = '#f00';
        });

        socket.on('connect_error', (error) => {
            statusDiv.textContent = 'Erreur de connexion ‚úó';
            statusDiv.style.color = '#f00';
            console.error('Connection error:', error);
        });

        function sendControl(action, direction = '') {
            if (socket && socket.connected) {
                socket.emit('control', { action, direction });
            }
        }

        /* --------- BOUTON ACC√âL√âRER (maintien = boost continu) --------- */

        function makeHoldButton(button, onTick) {
            let intervalId = null;

            const start = (e) => {
                e.preventDefault();
                if (intervalId !== null) return;

                button.style.transform = 'scale(0.95)';
                button.style.boxShadow = '0 0 8px rgba(255,255,255,0.4)';

                onTick();
                intervalId = setInterval(onTick, 60);
            };

            const stop = (e) => {
                if (e) e.preventDefault();
                if (intervalId !== null) {
                    clearInterval(intervalId);
                    intervalId = null;
                }
                button.style.transform = 'scale(1)';
                button.style.boxShadow = 'none';
            };

            ['pointerdown'].forEach(ev =>
                button.addEventListener(ev, start)
            );
            ['pointerup', 'pointercancel', 'pointerleave'].forEach(ev =>
                button.addEventListener(ev, stop)
            );

            button.addEventListener('contextmenu', e => e.preventDefault());
        }

        makeHoldButton(accelerateBtn, () => sendControl('accelerate'));

        /* --------- BOUTON TIR (pointerdown pour autoriser multitouch) --------- */

        let shootCooldown = false;
        shootButton.addEventListener('pointerdown', (e) => {
            e.preventDefault();
            if (!socket || !socket.connected) return;
            if (shootCooldown) return;

            shootCooldown = true;
            socket.emit('player-shoot');

            shootButton.innerHTML = '<span class="plane-icon">üî•</span> FIRE!';
            setTimeout(() => {
                shootButton.innerHTML = '<span class="plane-icon">üí•</span> Tirer';
                shootCooldown = false;
            }, 200);
        });

        /* --------- JOYSTICK (gauche/droite continu) --------- */

        let joystickActive = false;
        let joystickDirection = null; // 'left' / 'right' / null
        let joystickInterval = null;

        function setJoystickDirectionFromDelta(dx) {
            const deadZone = 10;
            if (dx > deadZone) {
                joystickDirection = 'right';
            } else if (dx < -deadZone) {
                joystickDirection = 'left';
            } else {
                joystickDirection = null;
            }
        }

        function updateJoystickKnob(clientX, clientY) {
            const baseRect = joystickBase.getBoundingClientRect();
            const knobRect = joystickKnob.getBoundingClientRect();

            const centerX = baseRect.width / 2;
            const centerY = baseRect.height / 2;

            // position relative dans la base
            const localX = clientX - baseRect.left;
            const localY = clientY - baseRect.top;

            let dx = localX - centerX;
            let dy = localY - centerY;

            const maxDist = baseRect.width / 2 - knobRect.width / 2;
            const dist = Math.sqrt(dx * dx + dy * dy);
            if (dist > maxDist) {
                const ratio = maxDist / dist;
                dx *= ratio;
                dy *= ratio;
            }

            joystickKnob.style.left = (centerX + dx - knobRect.width / 2) + 'px';
            joystickKnob.style.top  = (centerY + dy - knobRect.height / 2) + 'px';

            setJoystickDirectionFromDelta(dx);
        }

        function resetJoystick() {
            const baseRect = joystickBase.getBoundingClientRect();
            const knobRect = joystickKnob.getBoundingClientRect();
            joystickKnob.style.left = (baseRect.width / 2 - knobRect.width / 2) + 'px';
            joystickKnob.style.top  = (baseRect.height / 2 - knobRect.height / 2) + 'px';
            joystickDirection = null;
        }

        function startJoystickInterval() {
            if (joystickInterval !== null) return;
            joystickInterval = setInterval(() => {
                if (!joystickDirection) return;
                sendControl('move', joystickDirection);
            }, 60);
        }

        function stopJoystickInterval() {
            if (joystickInterval !== null) {
                clearInterval(joystickInterval);
                joystickInterval = null;
            }
        }

        joystickBase.addEventListener('pointerdown', (e) => {
            e.preventDefault();
            joystickActive = true;
            joystickBase.setPointerCapture(e.pointerId);
            updateJoystickKnob(e.clientX, e.clientY);
            startJoystickInterval();
        });

        joystickBase.addEventListener('pointermove', (e) => {
            if (!joystickActive) return;
            e.preventDefault();
            updateJoystickKnob(e.clientX, e.clientY);
        });

        const endJoystick = (e) => {
            if (!joystickActive) return;
            if (e) e.preventDefault();
            joystickActive = false;
            resetJoystick();
            stopJoystickInterval();
        };

        joystickBase.addEventListener('pointerup', endJoystick);
        joystickBase.addEventListener('pointercancel', endJoystick);
        joystickBase.addEventListener('pointerleave', endJoystick);
    </script>
</body>
</html>
